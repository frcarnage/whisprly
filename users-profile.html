<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile | Whisprly</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body style="font-family: sans-serif; padding: 20px; background: #f5f5f5;">
  <div id="profileContainer" style="max-width: 700px; margin: auto;"></div>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import {
      doc,
      getDoc,
      updateDoc,
      arrayUnion,
      arrayRemove,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const profileContainer = document.getElementById("profileContainer");

    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get("uid");

    let currentUser = null;

    async function getUserProfile(userId) {
      const userRef = doc(db, "users", userId);
      const snap = await getDoc(userRef);
      return snap.exists() ? { uid: userId, ...snap.data() } : null;
    }

    function createButton(text, color, onClick) {
      const btn = document.createElement("button");
      btn.innerText = text;
      btn.style = `
        padding: 0.6rem 1.2rem;
        margin: 0.5rem 0.25rem;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background-color: ${color};
        color: white;
      `;
      btn.onclick = onClick;
      return btn;
    }

    async function renderProfile() {
      const user = await getUserProfile(uid);
      if (!user) {
        profileContainer.innerHTML = "<p>User not found.</p>";
        return;
      }

      const isFollowing = currentUser?.following?.includes(uid);
      const isOwnProfile = currentUser?.uid === uid;

      const container = document.createElement("div");
      container.style = `
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      `;

      container.innerHTML = `
        <div style="display: flex; align-items: center; gap: 1.2rem;">
          <img src="${user.profilePic || 'https://via.placeholder.com/100'}"
               alt="Profile Pic"
               style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;" />
          <div>
            <h2 style="margin: 0;">${user.username || "Unknown"}
              ${user.isVerified ? `<img src="verified.png" style="width: 18px; height: 18px;">` : ""}
            </h2>
            <p style="color: gray;">${user.bio || "No bio provided."}</p>
            <p>ðŸ‘¥ <b>${user.followers?.length || 0}</b> Followers &nbsp;&nbsp; <b>${user.following?.length || 0}</b> Following</p>
          </div>
        </div>
      `;

      const actionWrapper = document.createElement("div");
      actionWrapper.style = "margin-top: 1.2rem;";

      if (!isOwnProfile) {
        const followBtn = isFollowing
          ? createButton("Unfollow", "#e53935", async () => {
              await updateDoc(doc(db, "users", currentUser.uid), {
                following: arrayRemove(uid)
              });
              await updateDoc(doc(db, "users", uid), {
                followers: arrayRemove(currentUser.uid)
              });
              location.reload();
            })
          : createButton("Follow", "#1e88e5", async () => {
              await updateDoc(doc(db, "users", currentUser.uid), {
                following: arrayUnion(uid)
              });
              await updateDoc(doc(db, "users", uid), {
                followers: arrayUnion(currentUser.uid)
              });
              location.reload();
            });

        const msgBtn = createButton("Message", "#43a047", () => {
          window.location.href = `chat.html?uid=${uid}`;
        });

        actionWrapper.appendChild(followBtn);
        actionWrapper.appendChild(msgBtn);
      } else {
        const editBtn = createButton("Edit Profile", "#5e35b1", () => {
          window.location.href = "edit-profile.html";
        });
        actionWrapper.appendChild(editBtn);
      }

      container.appendChild(actionWrapper);
      profileContainer.appendChild(container);
    }

    // ðŸ” Wait for auth then render
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Login required.");
        window.location.href = "/login.html";
        return;
      }

      currentUser = await getUserProfile(user.uid);
      renderProfile();
    });
  </script>
</body>
</html>
